/**
 * Regenerates app/tools/[slug]/client.tsx from the filesystem.
 *
 * Every .tsx file in components/tools/ becomes an entry in TOOLS_MAP.
 * Using static import() strings keeps webpack / Turbopack able to create
 * individual code-split chunks for each tool.
 *
 * Run manually:   node scripts/gen-tools-map.mjs
 * Runs automatically before every dev/build via the prebuild / predev hooks.
 */

import { readdirSync, writeFileSync } from "fs"
import { join, dirname } from "path"
import { fileURLToPath } from "url"

const root = join(dirname(fileURLToPath(import.meta.url)), "..")
const toolsDir = join(root, "components/tools")
const outputFile = join(root, "app/tools/[slug]/client.tsx")

const slugs = readdirSync(toolsDir)
  .filter((f) => f.endsWith(".tsx"))
  .map((f) => f.replace(".tsx", ""))
  .sort()

const mapEntries = slugs
  .map((s) => `  "${s}": dynamic(() => import("@/components/tools/${s}"), { loading }),`)
  .join("\n")

const content = `"use client"
// AUTO-GENERATED by scripts/gen-tools-map.mjs
// Run \`npm run gen:tools\` (or just start dev/build) to refresh after adding a tool.

import dynamic from "next/dynamic"
import type { ComponentType } from "react"

function LoadingDots() {
  return (
    <div className="flex flex-1 items-center justify-center py-24">
      <div className="flex gap-1.5">
        <span className="h-2 w-2 animate-bounce rounded-full bg-primary [animation-delay:-0.3s]" />
        <span className="h-2 w-2 animate-bounce rounded-full bg-primary [animation-delay:-0.15s]" />
        <span className="h-2 w-2 animate-bounce rounded-full bg-primary" />
      </div>
    </div>
  )
}

const loading = () => <LoadingDots />

/*
 * Every entry uses a static import path so webpack / Turbopack can create
 * individual code-split chunks â€” only the requested tool's JS is loaded.
 *
 * Tools that remain as iframe wrappers for now (complex canvas games):
 *   network-defense-game, password-cracking-simulator, password-quest,
 *   privacy-rpg, social-engineering-escape-room
 * All others are full React components sharing the design system.
 */
const TOOLS_MAP: Record<string, ComponentType> = {
${mapEntries}
}

export function ToolClientContent({ slug }: { slug: string }) {
  const Component = TOOLS_MAP[slug]
  if (!Component) {
    console.error(\`ToolClientContent: no component registered for slug "\${slug}"\`)
    return null
  }
  return <Component />
}
`

writeFileSync(outputFile, content)
console.log(`gen-tools-map: wrote ${slugs.length} entries to app/tools/[slug]/client.tsx`)
